"use strict";(()=>{var e={};e.id=867,e.ids=[867],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},1267:e=>{e.exports=require("worker_threads")},9796:e=>{e.exports=require("zlib")},8036:(e,t,l)=>{l.r(t),l.d(t,{headerHooks:()=>g,originalPathname:()=>x,patchFetch:()=>E,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>w});var r={};l.r(r),l.d(r,{POST:()=>b,runtime:()=>p});var a=l(5419),o=l(9108),i=l(9678),n=l(8070),s=l(5683),u=l(6700),c=l(5752);let p="nodejs",d=["volleyball double contact fault hand signal","volleyball four hits fault team violation","volleyball net touch fault player contact rules","volleyball foot fault service line violation","volleyball back row attack rules fault","volleyball lift carry fault ball handling","volleyball rotation fault positional error","volleyball center line foot crossing violation","volleyball attack hit blocking fault","volleyball ball handling judgment double hit","volleyball service rules order procedures","volleyball service fault toss eight seconds","volleyball let serve net service rules","volleyball service screen illegal formation","volleyball serving order rotation violation","volleyball blocking rules back row player","volleyball simultaneous contact block attack","volleyball attack line three meter rule","volleyball joust ball simultaneous hit","volleyball block touch team hits count","volleyball net contact rules interference","volleyball reaching over net blocking rules","volleyball penetration under net rules","volleyball antenna touch ball out rules","volleyball rotation order position fault","volleyball overlap positional rules check","volleyball libero replacement rules substitution","volleyball libero attack restriction rules","volleyball setter position overlap check","volleyball ball in out line decision","volleyball antenna ball contact outside","volleyball ceiling contact rules play","volleyball ball touching boundary lines","volleyball timeout rules duration procedure","volleyball substitution rules procedure limits","volleyball injury timeout protocol rules","volleyball delay warning sanction rules","volleyball coin toss first serve choice","volleyball scoring rally point system","volleyball deciding set rules fifth set","volleyball side switch rules procedures","volleyball point award replay situations","volleyball misconduct sanctions cards penalties","volleyball yellow card red card rules","volleyball coach conduct sideline rules","volleyball expulsion disqualification rules","volleyball referee hand signals official","volleyball first referee second referee duties","volleyball line judge signals responsibilities","volleyball scoresheet recording procedures","volleyball replay situations circumstances","volleyball interference external objects rules","volleyball ball becomes dead situations","volleyball rally interruption circumstances"],m=["game situation judgment call","rule interpretation edge case","referee positioning and decision","hand signal identification","fault recognition scenario","sanction and penalty application","procedural knowledge test","complex multi-fault situation"];async function b(e){let t,l;try{(0,c.V1)(["OPENAI_API_KEY","SUPABASE_SERVICE_KEY","SUPABASE_URL"])}catch(e){return n.Z.json({error:"Missing environment variables",details:e.message},{status:500})}try{t=await e.json()}catch{t={}}let{difficulty:r="medium"}=t,a=["easy","medium","hard"].includes(r)?r:"medium",o=[...d].sort(()=>Math.random()-.5).slice(0,3),i=m[Math.floor(Math.random()*m.length)],p=[];try{let e=o.map(e=>(0,s.D)(e,4));for(let t of(await Promise.all(e)))t&&t.length>0&&p.push(...t)}catch(e){return n.Z.json({error:"Failed to search rules",details:e.message},{status:500})}if(0===p.length)return n.Z.json({error:"No rules found in database",hint:"Please upload and embed the rulebook first using /api/upload-rules and /api/embed-rules"},{status:400});let b=Array.from(new Map(p.map(e=>[e.chunk.slice(0,100),e])).values()).sort(()=>Math.random()-.5).slice(0,5),h=o[0].replace("volleyball ","").replace(/ /g,", "),f={easy:`
      - Focus on fundamental rules that every referee must know
      - Clear-cut scenarios with obvious correct answers
      - Basic terminology and common game situations
      - Examples: basic faults, simple rotation questions, common hand signals`,medium:`
      - Intermediate rule applications requiring good judgment
      - Scenarios with subtle distinctions between options
      - Rule interactions and timing considerations
      - Examples: back row attack nuances, block touch counting, libero restrictions`,hard:`
      - Complex scenarios with multiple rules interacting
      - Edge cases and unusual situations that test deep knowledge
      - Require understanding of rule priorities and exceptions
      - Examples: simultaneous faults, replay vs point decisions, sanction escalation`},y=`You are an elite volleyball referee trainer and FIVB rules expert. Your task is to create ONE highly specific, practical quiz question that will genuinely help referees improve their officiating skills.

CRITICAL REQUIREMENTS:
1. The question MUST be based on a realistic game situation that a referee would actually encounter
2. Include specific details: player positions, game score context if relevant, exact actions
3. All 4 options must be plausible - no obviously wrong answers
4. The correct answer MUST be one of the exact option strings you provide
5. The explanation must cite the specific rule number/section from FIVB rules

QUESTION FOCUS AREA: ${h}
SCENARIO TYPE: ${i}
DIFFICULTY: ${a}
${f[a]}

RANDOMIZATION SEED: ${Math.floor(1e4*Math.random())} (use this to vary your approach - different scenario angles, different team perspectives, different phases of play)

STRICT JSON FORMAT - Return ONLY valid JSON:
{
  "question": "A detailed, specific scenario question (include player positions, actions, timing)",
  "options": [
    "Option A - Complete answer text",
    "Option B - Complete answer text",
    "Option C - Complete answer text", 
    "Option D - Complete answer text"
  ],
  "answer": "Option X - Complete answer text (MUST be EXACTLY one of the options above, including the letter prefix)",
  "explanation": "Detailed explanation of why this is correct, referencing the specific rule (e.g., Rule 12.4.1)",
  "rule_reference": "Rule X.X.X - Brief rule title"
}

QUALITY CHECKLIST:
- Is this question specific enough that only one answer can be correct?
- Would a referee encounter this exact scenario in a real match?
- Does the explanation teach something valuable?
- Are the wrong options realistic mistakes a referee might make?`,v=(0,c.aZ)(b);try{l=await (0,u.X)([{role:"system",content:y},{role:"user",content:`Based on these official volleyball rules, create a ${a} difficulty question:

${v}

Remember: Return ONLY valid JSON. The "answer" field must be the COMPLETE text of one of your options, including the letter prefix (e.g., "Option A - The correct answer text").`}],"gpt-4o",{temperature:.85})}catch(e){return n.Z.json({error:"Failed to generate question from LLM",details:e.message},{status:500})}try{let e=l.trim();e.startsWith("```json")?e=e.slice(7):e.startsWith("```")&&(e=e.slice(3)),e.endsWith("```")&&(e=e.slice(0,-3)),e=e.trim();let t=JSON.parse(e);if(!t.question||!t.options||!t.answer||!t.explanation)throw Error("Missing required fields in response");if(!Array.isArray(t.options)||4!==t.options.length)throw Error("Options must be an array of 4 strings");let r=t.options.map(e=>e.replace(/^(Option\s+)?[A-D][\s\-\.\)]+/i,"").trim()),a=t.answer.replace(/^(Option\s+)?[A-D][\s\-\.\)]+/i,"").trim();if(!r.includes(a)){let e=a.toLowerCase(),t=r.find(t=>t.toLowerCase().includes(e)||e.includes(t.toLowerCase()));t?a=t:(console.warn("Answer didn't match options, falling back to first option"),a=r[0])}return n.Z.json({question:t.question,options:r,answer:a,explanation:t.explanation,rule_reference:t.rule_reference||null,context:b})}catch(e){return n.Z.json({error:"Failed to parse model response as JSON",raw:l,context:b},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/generate-question/route",pathname:"/api/generate-question",filename:"route",bundlePath:"app/api/generate-question/route"},resolvedPagePath:"/Users/harrisonwang/ovafinal/app/api/generate-question/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:v,headerHooks:g,staticGenerationBailout:w}=h,x="/api/generate-question/route";function E(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},7399:(e,t,l)=>{l.d(t,{OC:()=>o,UI:()=>i});let r=new(l(6168)).ZP({apiKey:process.env.OPENAI_API_KEY}),a="text-embedding-3-small";async function o(e){let t=e.replace(/\n/g," ");return(await r.embeddings.create({model:a,input:t})).data[0].embedding}async function i(e){return(await r.embeddings.create({model:a,input:e.map(e=>e.replace(/\n/g," "))})).data.map(e=>e.embedding)}},6700:(e,t,l)=>{l.d(t,{X:()=>a});let r=new(l(6168)).ZP({apiKey:process.env.OPENAI_API_KEY});async function a(e,t="gpt-4o-mini",l={}){let{temperature:a=.7,maxTokens:o}=l,i=await r.chat.completions.create({model:t,messages:e,temperature:a,...o&&{max_tokens:o}});return i.choices[0]?.message?.content??""}},5683:(e,t,l)=>{l.d(t,{D:()=>i,k:()=>o});var r=l(7399),a=l(8234);function o(e,t=800,l=80){let r=e.split(/\s+/),a=[],o=0;for(;o<r.length;){let e=r.slice(o,o+t).join(" ");a.push(e),o+=t-l}return a}async function i(e,t=5){let l=(0,a.b)(),o=await (0,r.OC)(e),{data:i,error:n}=await l.rpc("match_rules",{query_embedding:o,match_count:t});if(n)throw n;return i||[]}},8234:(e,t,l)=>{l.d(t,{b:()=>i});var r=l(7493);let a="https://uglzhvquiarxyahsnesj.supabase.co",o=process.env.SUPABASE_SERVICE_KEY,i=()=>{if(!a||!o)throw Error("Supabase environment variables missing (SUPABASE_URL, SUPABASE_SERVICE_KEY).");return(0,r.eI)(a,o,{global:{headers:{"x-client-info":"volleyball-ref-training"}},auth:{autoRefreshToken:!1,detectSessionInUrl:!1,persistSession:!1}})}},5752:(e,t,l)=>{function r(e){switch(e){case"easy":return 3;case"medium":return 4;case"hard":return 5;default:return 6}}function a(e){return e.map((e,t)=>`Rule Snippet ${t+1}${e.similarity?` (sim ${e.similarity.toFixed(2)})`:""}:
${e.chunk}`).join("\n\n")}function o(e){let t=e.filter(e=>!process.env[e]);if(t.length)throw Error(`Missing environment variables: ${t.join(", ")}`)}l.d(t,{V1:()=>o,aZ:()=>a,uF:()=>r})}};var t=require("../../../webpack-runtime.js");t.C(e);var l=e=>t(t.s=e),r=t.X(0,[638,164,168],()=>l(8036));module.exports=r})();